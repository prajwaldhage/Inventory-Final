<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing Page - D-Mart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- jQuery is required for the entire application logic -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom scrollbar styles */
        .overflow-y-auto::-webkit-scrollbar { width: 8px; }
        .overflow-y-auto::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .overflow-y-auto::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 10px; }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover { background: #a1a1aa; }

        /* FIX APPLIED: ensures suggestions overlay the sticky header (z-index: 99) */
        .suggestions-container {
            position: absolute;
            top: 100%;
            left: 0;
            border: 1px solid #ddd;
            border-top: none;
            z-index: 99;
            width: 100%;
            max-height: 150px;
            overflow-y: auto;
            background-color: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .suggestion-item { padding: 10px; cursor: pointer; }
        .suggestion-item:hover { background-color: #f0f0f0; }
        /* Toast style */
        .toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
            border-radius: 8px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px;
            transform: translateX(-50%); opacity: 0; transition: opacity 0.5s, visibility 0.5s;
        }
        .toast.show { visibility: visible; opacity: 1; }
        /* Modal printing styles */
        @media print {
            body * { visibility: hidden; }
            #bill-preview-modal, #bill-preview-modal * { visibility: visible; }
            #bill-preview-modal { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; }
            .no-print { display: none; }
        }
        /* FIX: Ensure dropdown menu also overlays sticky header */
        #dropdownMenu {
            z-index: 100;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
<script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'custom-purple': '#6D5BD0',
            'custom-light-purple': '#F0EEFF',
            'custom-background': '#F8F9FE',
            'custom-gray': '#A0AEC0',
            'custom-dark-gray': '#4A5568',
            'custom-light-gray': '#F7FAFC',
            'custom-green': '#48BB78',
            'custom-red': '#F56565',
          },
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        }
      }
    }
</script>
<!-- Billing Form Container -->
<div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-white p-6 flex flex-col justify-between shadow-md">
        <div>
            <div class="mb-8"><h1 class="text-3xl font-bold text-center text-gray-800">D-Mart</h1></div>
            <nav>
                <ul>
                    <li class="mb-2">
                        <a href="{{url_for('dashboard')}}"
                           class="flex items-center p-3 hover:bg-gray-100 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round" class="sidebar-icon mr-3">
                                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                            </svg>
                            DASHBOARD
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="{{url_for('inventory_page')}}"
                           class="flex items-center p-3 hover:bg-gray-100 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round" class="sidebar-icon mr-3">
                                <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"></path>
                                <path d="m3.3 7 8.7 5 8.7-5"></path>
                                <path d="M12 22V12"></path>
                            </svg>
                            INVENTORY
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="{{url_for('billing_page')}}"
                           class="flex items-center p-3 bg-custom-light-purple text-custom-purple rounded-lg font-semibold">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round" class="sidebar-icon mr-3">
                                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                                <rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect>
                            </svg>
                            BILLING
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="{{url_for('reports_hub')}}" class="flex items-center p-3 hover:bg-gray-100 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round" class="sidebar-icon mr-3">
                                <path d="M3 3v18h18"></path>
                                <path d="M18.7 8a6 6 0 0 0-8.4-8.4"></path>
                                <path d="M13 10.5a2.5 2.5 0 0 1-3.5-3.5"></path>
                            </svg>
                            REPORTS
                        </a>
                    </li>
                    <li>
                        <a href="{{url_for('about')}}" class="flex items-center p-3 hover:bg-gray-100 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round" class="sidebar-icon mr-3">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M12 16v-4"></path>
                                <path d="M12 8h.01"></path>
                            </svg>
                            ABOUT
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
        <div class="flex items-center">
            <img src="https://placehold.co/40x40/E2E8F0/4A5568?text=OM" alt="User Avatar" class="rounded-full mr-3"
                 onerror="this.onerror=null;this.src='https://placehold.co/40x40/E2E8F0/4A5568?text=OM';">
            <div>
                <p class="font-semibold">OM KHEBADE</p>
                <a href="/setting/user.profile.html" class="text-sm text-gray-500 hover:underline">View Profile</a>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                 class="ml-auto text-gray-500">
                <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
                <circle cx="12" cy="12" r="3"></circle>
            </svg>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 min-w-0 flex flex-row bg-gray-100 p-4 sm:p-6">
        <form id="main-billing-form" class="flex flex-row flex-1">
            <!-- Left Column: Billing Form and Table -->
            <section class="flex flex-col bg-white p-6 rounded-2xl shadow-lg flex-1 mr-8">
                <!-- HEADER -->
                <div class="flex-shrink-0 flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">New Bill</h1>
                    <p class="text-sm font-medium text-gray-600">Bill Date: <span id="live-date"></span></p>
                </div>

                <!-- Customer Details -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                    <div class="relative">
                        <label for="customer_name" class="text-sm font-medium text-gray-600">Customer Name:</label>
                        <input type="text" id="customer_name" name="customer_name" placeholder="Enter Name..." required
                               class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                               autocomplete="off">
                        <div id="name-suggestions" class="suggestions-container rounded-b-lg hidden"></div>
                    </div>
                    <div>
                        <label for="phoneNo" class="text-sm font-medium text-gray-600">Phone No:</label>
                        <input type="tel" id="phoneNo" name="phone" placeholder="Enter Number..." required
                               class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="customerTypeBtn" class="text-sm font-medium text-gray-700">Customer Type:</label>
                        <div class="relative mt-1">
                            <!-- Hidden input to hold the value -->
                            <input type="hidden" id="customer_type_hidden" name="customer_type" required value="">
                            <button type="button" id="customerTypeBtn"
                                    class="w-full px-4 py-2 text-left bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 flex justify-between items-center">
                                <span id="selectedCustomerType">Select Type</span>
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </button>
                            <div id="dropdownMenu"
                                 class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden">
                                <ul class="py-1">
                                    <li><a href="#"
                                           class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dropdown-item"
                                           data-type="Wholesaler">Wholesaler</a></li>
                                    <li><a href="#"
                                           class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dropdown-item"
                                           data-type="Retailer">Retailer</a></li>
                                    <li><a href="#"
                                           class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dropdown-item"
                                           data-type="Hotel">Hotel-Line</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Search -->
                <div class="mt-2 relative">
                    <input type="text" id="product-search-input" placeholder="+ Add Products (Search by Name/Brand)..."
                           class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                           autocomplete="off" disabled>
                    <i class="fas fa-search text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2"></i>
                    <div id="product-suggestions" class="suggestions-container hidden"></div>
                </div>

                <!-- Billing Table -->
                <div class="flex flex-col flex-grow min-h-0 mt-6">
                    <div class="main-content-area flex-grow overflow-y-auto border rounded-lg">
                        <table class="min-w-full bg-white">
                            <thead class="bg-purple-100 sticky top-0 z-10">
                            <tr>
                                <!-- START: ADDED SR NO. COLUMN -->
                                <th class="px-4 py-3 text-left text-xs font-semibold text-purple-800 uppercase">Sr No.
                                </th>
                                <!-- END: ADDED SR NO. COLUMN -->
                                <th class="px-4 py-3 text-left text-xs font-semibold text-purple-800 uppercase">Product
                                    Name
                                </th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-purple-800 uppercase">Qty
                                </th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-purple-800 uppercase">Rate
                                </th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-purple-800 uppercase">Total
                                </th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-purple-800 uppercase">
                                    Action
                                </th>
                            </tr>
                            </thead>
                            <tbody id="billing-tbody" class="divide-y divide-gray-200">
                            <!-- Dynamic product rows -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Footer: Total -->
                <div class="flex-shrink-0 flex justify-end items-center mt-4 p-4 bg-gray-50 rounded-lg">
                    <span id="total-items-qty" class="text-sm font-semibold text-gray-700">Total Items (Qty): 0</span>
                </div>
            </section>

            <!-- Right Column: Order Summary and Payment -->
            <aside class="w-full max-w-xs flex flex-col">
                <div class="bg-white p-6 rounded-2xl shadow-lg h-full flex flex-col">
                    <div class="flex-grow flex flex-col">
                        <h2 class="text-xl font-bold text-gray-800 mb-2">Order Summary</h2>
                        <div id="order-summary-list-container" class="max-h-32 overflow-y-auto pr-2">
                            <div id="order-summary-list" class="space-y-1 text-sm">
                                <p class="text-gray-500 text-xs">Add products to see summary.</p>
                            </div>
                        </div>
                        <hr class="my-3">
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Discount/Savings</span>
                                <span id="summary-discount" class="font-medium text-red-500">₹0.00</span>
                            </div>
                            <div class="flex justify-between font-semibold">
                                <span class="text-gray-800">Subtotal (Net Sale)</span>
                                <span id="summary-subtotal" class="text-gray-900">₹0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Tax (5% of Net Sale)</span>
                                <span id="summary-tax" class="font-medium text-gray-800">₹0.00</span>
                            </div>
                        </div>
                        <hr class="my-3">
                        <div class="flex justify-between items-center text-xl font-bold">
                            <span class="text-gray-800">TOTAL DUE</span>
                            <span id="summary-order-total" class="text-purple-700">₹0.00</span>
                        </div>
                        <div class="mt-3 bg-green-100 text-green-700 text-center py-2 rounded-lg text-sm font-semibold">
                            Total Profit Margin: <span id="profit-margin" class="font-bold">N/A</span>
                        </div>
                        <div class="mt-3 flex">
                            <input type="text" placeholder="Coupon code"
                                   class="w-full px-4 py-2 border border-r-0 border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <button type="button"
                                    class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-r-lg hover:bg-gray-300">
                                Apply
                            </button>
                        </div>
                    </div>

                    <div class="flex-shrink-0 mt-6">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-lg font-bold text-gray-800">Payment Method</h3>
                        </div>
                        <input type="hidden" id="payment_method_hidden" name="payment_method" value="UPI">
                        <div class="grid grid-cols-4 gap-2 mb-4" id="payment-methods">
                            <button type="button" data-method="Online"
                                    class="payment-method-btn py-2 px-3 text-sm font-bold rounded-lg transition-colors bg-purple-600 text-white">
                                UPI
                            </button>
                            <button type="button" data-method="CARD"
                                    class="payment-method-btn py-2 px-3 text-sm font-bold rounded-lg transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">
                                Card
                            </button>
                            <button type="button" data-method="CASH"
                                    class="payment-method-btn py-2 px-3 text-sm font-bold rounded-lg transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">
                                Cash
                            </button>
                            <button type="button" data-method="CREDIT"
                                    class="payment-method-btn py-2 px-3 text-sm font-bold rounded-lg transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">
                                Credit
                            </button>
                        </div>
                        <div id="due-date-container" class="hidden mb-4">
                            <label for="due-date" class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                            <input type="date" id="due-date"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div class="mt-4 grid grid-cols-2 gap-4">
                            <button type="button" id="clear-bill-btn"
                                    class="w-full py-3 bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300 transition-colors">
                                <i class="fas fa-undo mr-1"></i>Clear Bill
                            </button>
                            <button type="button" id="pay-and-print-btn"
                                    class="w-full py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition-colors">
                                <i class="fas fa-print mr-1"></i>Pay & Print
                            </button>
                        </div>
                    </div>
                </div>
            </aside>
        </form>
    </main>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast"></div>

<!-- Bill Preview Modal (Updated for the new design) -->
<div id="bill-preview-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full bill-preview-content overflow-hidden">
        <div class="bg-gray-100 p-4 border-b">
            <h2 class="text-xl font-bold text-center text-gray-700 flex items-center justify-center"><i
                    class="fas fa-receipt mr-3"></i>Invoice Preview - Bill ID: <span id="modal-bill-id">N/A</span></h2>
        </div>
        <div class="p-8 text-sm">
            <div class="grid grid-cols-2 gap-4 mb-6 border-b pb-4">
                <div><p class="text-gray-600">Customer:</p>
                    <p id="modal-customer-name" class="font-semibold"></p></div>
                <div><p class="text-gray-600">Phone:</p>
                    <p id="modal-phone" class="font-semibold"></p></div>
                <div><p class="text-gray-600">Type:</p>
                    <p id="modal-customer-type" class="font-semibold"></p></div>
                <div><p class="text-gray-600">Payment:</p>
                    <p id="modal-payment-method" class="font-semibold"></p></div>
            </div>

            <table class="w-full text-sm mb-6">
                <thead>
                <tr class="border-b">
                    <th class="text-left py-2">Product</th>
                    <th class="text-center py-2">Qty</th>
                    <th class="text-right py-2">Rate</th>
                    <th class="text-right py-2">Total</th>
                </tr>
                </thead>
                <tbody id="modal-products-body"></tbody>
            </table>

            <div class="flex justify-end">
                <div class="w-1/2">
                    <div class="flex justify-between mb-2"><span class="text-gray-600">Subtotal:</span><span
                            id="modal-subtotal" class="font-semibold"></span></div>
                    <div class="flex justify-between mb-2"><span class="text-gray-600">Tax (5%):</span><span
                            id="modal-tax" class="font-semibold"></span></div>
                    <div class="flex justify-between font-bold text-lg border-t pt-2"><span>TOTAL DUE:</span><span
                            id="modal-total" class="text-purple-600"></span></div>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 p-4 text-center no-print">
            <button id="confirm-save-btn"
                    class="btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-md mr-4">
                <i class="fas fa-save mr-2"></i>Confirm & Save Bill
            </button>
            <button id="close-modal-btn"
                    class="btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-md">Close
            </button>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // --- Global State and Constants ---
        const TAX_RATE = 0.05;
        let productCounter = 0;
        let productsInBill = []; // Stores objects { id, name, price, quantity }
        let currentCustomerType = '';
        let selectedPaymentMethod = 'UPI';

        // --- DOM Elements ---
        const productsBody = $('#billing-tbody');
        const searchInput = $('#product-search-input');
        const customerNameInput = $('#customer_name');
        const phoneInput = $('#phoneNo');
        const customerTypeHidden = $('#customer_type_hidden');
        const customerTypeDisplay = $('#selectedCustomerType');

        // Summary elements
        const totalItemsQtyEl = $('#total-items-qty');
        const summaryDiscountEl = $('#summary-discount');
        const summarySubtotalEl = $('#summary-subtotal');
        const summaryTaxEl = $('#summary-tax');
        const summaryOrderTotalEl = $('#summary-order-total');
        const summarySavingsEl = $('#summary-savings');

        // --- Utility Functions ---
        function formatRupee(amount) {
            return `₹${parseFloat(amount).toFixed(2)}`;
        }

        function showToast(message, isError = false) {
            const toastElement = $('#toast');
            toastElement.text(message);
            toastElement.removeClass('bg-red-600 bg-gray-800').addClass(isError ? 'bg-red-600' : 'bg-gray-800');
            toastElement.addClass('show');
            setTimeout(() => toastElement.removeClass('show'), 3000);
        }

        function handleAjaxError(jqXHR, textStatus, errorThrown, context) {
            let errorMessage = `Error: Could not ${context}.`;
            if (jqXHR.responseJSON && jqXHR.responseJSON.error) {
                errorMessage += ` ${jqXHR.responseJSON.error}`;
            } else if (textStatus === 'error') {
                errorMessage += ` Server may be down or unreachable.`;
            }
            showToast(errorMessage, true);
        }

        function setCurrentDate() {
            const now = new Date();
            $('#live-date').text(now.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' }));
        }

        function resetForm() {
            productsInBill = [];
            productsBody.html('');
            customerNameInput.val('');
            phoneInput.val('');
            customerTypeHidden.val('');
            customerTypeDisplay.text('Select Type');
            searchInput.prop('disabled', true).val('');
            $('#dropdownMenu').find('.dropdown-item').removeClass('bg-purple-100 font-bold');
            $('#payment-methods').find('.payment-method-btn[data-method="UPI"]').trigger('click');
            $('#due-date-container').addClass('hidden');
            calculateTotals();
            setCurrentDate();
        }

        // --- Product Row Logic ---
        function addProductToBill(productName, price) {
            // Check if product is already in bill, update quantity instead
            const existing = productsInBill.find(p => p.name === productName);
            if (existing) {
                existing.quantity++;
                showToast(`Quantity of ${productName} increased to ${existing.quantity}.`);
                calculateTotals();
                return;
            }

            const newProduct = {
                id: productCounter++,
                name: productName,
                price: parseFloat(price),
                quantity: 1
            };
            productsInBill.push(newProduct);
            calculateTotals();
        }

        // --- MODIFIED generateProductRow to include buttons and index for Sr No. ---
        function generateProductRow(product, index) {
            const rowTotal = product.price * product.quantity;
            return `
                <tr class="hover:bg-gray-50 product-row" data-id="${product.id}">
                    <!-- ADDED SR NO. CELL -->
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}.</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${product.name}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">
                        <div class="flex items-center justify-center space-x-2">
                            <button type="button" data-id="${product.id}" class="decrease-qty-btn w-6 h-6 rounded-full flex items-center justify-center bg-red-100 text-red-600 hover:bg-red-200 transition-colors">
                                <i class="fas fa-minus text-xs"></i>
                            </button>
                            <span class="font-semibold w-8 text-center current-qty">${product.quantity}</span>
                            <button type="button" data-id="${product.id}" class="increase-qty-btn w-6 h-6 rounded-full flex items-center justify-center bg-green-100 text-green-600 hover:bg-green-200 transition-colors">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                        </div>
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 text-right">
                        ${formatRupee(product.price)}
                        <input type="hidden" class="price-input" value="${product.price}">
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-semibold text-gray-900 text-right total-amount">${formatRupee(rowTotal)}</td>
                    <td class="px-4 py-2 text-center">
                        <button type="button" data-id="${product.id}" class="remove-product-btn text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }
        // --- END MODIFIED generateProductRow ---

        function calculateTotals() {
            let subtotal = 0;
            let totalQty = 0;
            let totalSavings = 0;

            // Recalculate based on current productsInBill
            productsBody.html('');
            $('#order-summary-list').html('');

            if (productsInBill.length === 0) {
                $('#order-summary-list').html('<p class="text-gray-500 text-xs">Add products to see summary.</p>');
            }

            productsInBill.forEach((p, index) => {
                const rowTotal = p.price * p.quantity;
                subtotal += rowTotal;
                totalQty += p.quantity;

                // For Savings, we need MRP. Since we don't fetch MRP, we cannot calculate actual savings.
                // For simplicity, we'll keep savings at 0 or base it on a simple discount logic if needed,
                // but based on your previous code, let's keep it simple: total savings is 0 for now unless
                // you want to hardcode an MRP assumption. We will keep it 0 to be safe.
                // The provided HTML uses placeholder savings, let's stick to safe calculation.

                // Render table row - PASSING INDEX HERE
                productsBody.append(generateProductRow(p, index));

                // Render summary item
                $('#order-summary-list').append(`
                    <div class="flex justify-between">
                        <span class="text-gray-600 truncate pr-2">X${p.quantity} ${p.name}</span>
                        <span class="font-medium text-gray-800">${formatRupee(rowTotal)}</span>
                    </div>
                `);
            });

            const tax = subtotal * TAX_RATE; // 5% tax
            const total = subtotal + tax;

            // Update main summary panel
            totalItemsQtyEl.text(`Total Items (Qty): ${totalQty}`);
            summaryDiscountEl.text(formatRupee(totalSavings)); // Currently 0
            summarySavingsEl.text(formatRupee(totalSavings)); // Currently 0
            summarySubtotalEl.text(formatRupee(subtotal));
            summaryTaxEl.text(formatRupee(tax));
            summaryOrderTotalEl.text(formatRupee(total));
        }

        // --- Event Listeners Initialization ---

        // Customer Search (Autosuggest)
        customerNameInput.on('keyup', function() {
            const query = $(this).val();
            const suggestionsBox = $('#name-suggestions');
            if (query.length < 2) {
                suggestionsBox.html('').addClass('hidden');
                return;
            }
            $.ajax({
                url: '/api/customers',
                data: { term: query },
                success: (data) => {
                    suggestionsBox.html('').addClass('hidden');
                    if (data.length) {
                        data.forEach(customer => {
                            const item = $(`<div class="suggestion-item">${customer.name} - ${customer.mobile} (${customer.type})</div>`).data('customer', customer);
                            suggestionsBox.append(item);
                        });
                        suggestionsBox.removeClass('hidden');
                    }
                }
            }).fail((jqXHR, s, e) => handleAjaxError(jqXHR, s, e, "fetch customer suggestions"));
        });

        $('#name-suggestions').on('click', '.suggestion-item', function() {
            const customer = $(this).data('customer');
            customerNameInput.val(customer.name);
            phoneInput.val(customer.mobile);

            // Set Customer Type from selection
            currentCustomerType = customer.type;
            customerTypeHidden.val(customer.type.toUpperCase().replace('-', ''));
            customerTypeDisplay.text(customer.type);
            searchInput.prop('disabled', false); // Enable product search
            $('#dropdownMenu').find('.dropdown-item').removeClass('bg-purple-100 font-bold');
            $(`#dropdownMenu a:contains(${customer.type})`).addClass('bg-purple-100 font-bold');

            $('#name-suggestions').addClass('hidden');
            showToast(`Customer type set to: ${customer.type}`);
        });

        // Product Search (Autosuggest)
        searchInput.on('keyup', function() {
            const query = $(this).val();
            const suggestionsBox = $('#product-suggestions');

            if (query.length < 2 || !currentCustomerType) {
                suggestionsBox.html('').addClass('hidden');
                return;
            }
            $.ajax({
                url: '/api/products',
                data: { term: query, customer_type: currentCustomerType.toUpperCase().replace('-', '') },
                success: (data) => {
                    suggestionsBox.html('').addClass('hidden');
                    if (data.length > 0) {
                        data.forEach(product => {
                            const item = $(`<div class="suggestion-item">${product.name} (${formatRupee(product.price)})</div>`).data('product', product);
                            suggestionsBox.append(item);
                        });
                        suggestionsBox.removeClass('hidden');
                    }
                }
            }).fail((jqXHR, s, e) => handleAjaxError(jqXHR, s, e, "fetch product prices"));
        });

        $('#product-suggestions').on('click', '.suggestion-item', function() {
            const product = $(this).data('product');
            addProductToBill(product.name, product.price);
            searchInput.val('');
            $('#product-suggestions').addClass('hidden');
        });

        // Customer Type Dropdown/Button Logic
        $('#customerTypeBtn').on('click', () => $('#dropdownMenu').toggleClass('hidden'));
        $('#dropdownMenu').on('click', '.dropdown-item', function(e) {
            e.preventDefault();
            const type = $(this).data('type');
            currentCustomerType = type;
            customerTypeHidden.val(type.toUpperCase().replace('-', ''));
            customerTypeDisplay.text(type);
            $('#dropdownMenu').addClass('hidden');
            searchInput.prop('disabled', false); // Enable product search
            $('#dropdownMenu').find('.dropdown-item').removeClass('bg-purple-100 font-bold');
            $(this).addClass('bg-purple-100 font-bold');
            showToast(`Customer type set to: ${type}`);
            // Clear products list if type changes to avoid price conflicts
            productsInBill = [];
            calculateTotals();
        });

        // --- Quantity Button Click Handlers ---
        productsBody.on('click', '.increase-qty-btn', function() {
            const id = $(this).data('id');
            const product = productsInBill.find(p => p.id === id);
            if (product) {
                product.quantity++;
                calculateTotals(); // Re-renders the table and updates summary
            }
        });

        productsBody.on('click', '.decrease-qty-btn', function() {
            const id = $(this).data('id');
            const product = productsInBill.find(p => p.id === id);
            if (product && product.quantity > 1) {
                product.quantity--;
                calculateTotals(); // Re-renders the table and updates summary
            } else if (product && product.quantity === 1) {
                // Remove product if quantity hits one and user tries to decrease again
                productsInBill = productsInBill.filter(p => p.id !== id);
                showToast(`${product.name} removed from bill.`, true);
                calculateTotals();
            }
        });
        // --- End Quantity Button Click Handlers ---


        productsBody.on('click', '.remove-product-btn', function() {
            const id = $(this).data('id');
            productsInBill = productsInBill.filter(p => p.id !== id);
            calculateTotals();
        });

        // Payment Method Selection
        $('#payment-methods').on('click', '.payment-method-btn', function() {
            const method = $(this).data('method');
            selectedPaymentMethod = method;
            $('#payment_method_hidden').val(method);

            // Update button styles
            $('#payment-methods').find('.payment-method-btn').each(function() {
                $(this).removeClass('bg-purple-600 text-white').addClass('bg-gray-200 text-gray-700 hover:bg-gray-300');
            });
            $(this).addClass('bg-purple-600 text-white').removeClass('bg-gray-200 text-gray-700 hover:bg-gray-300');

            // Show due date for Credit
            if (method === 'CREDIT') {
                $('#due-date-container').removeClass('hidden');
            } else {
                $('#due-date-container').addClass('hidden');
            }
        });

        // Clear Bill Button
        $('#clear-bill-btn').on('click', resetForm);

        // Pay & Print Button (Triggers Preview/Modal)
        $('#pay-and-print-btn').on('click', function(e) {
            e.preventDefault();
            if (!customerNameInput.val() || !phoneInput.val() || !customerTypeHidden.val()) {
                showToast("Please fill out customer details completely.", true);
                return;
            }
            if (productsInBill.length === 0) {
                showToast("Please add at least one product to the bill.", true);
                return;
            }
            showBillPreview();
        });


        // --- Modal Functions and Final Submission ---
        function showBillPreview() {
            // Populate modal with current form data
            $('#modal-customer-name').text(customerNameInput.val());
            $('#modal-phone').text(phoneInput.val());
            $('#modal-customer-type').text(customerTypeDisplay.text());
            $('#modal-payment-method').text(selectedPaymentMethod);

            // Populate modal table
            const modalProductsBody = $('#modal-products-body');
            modalProductsBody.html('');
            productsInBill.forEach(p => {
                modalProductsBody.append(`
                    <tr>
                        <td class="py-2">${p.name}</td>
                        <td class="text-center py-2">${p.quantity}</td>
                        <td class="text-right py-2">${formatRupee(p.price)}</td>
                        <td class="text-right py-2">${formatRupee(p.price * p.quantity)}</td>
                    </tr>
                `);
            });

            // Populate modal summary
            $('#modal-subtotal').text(summarySubtotalEl.text());
            $('#modal-tax').text(summaryTaxEl.text());
            $('#modal-total').text(summaryOrderTotalEl.text());

            $('#bill-preview-modal').removeClass('hidden');
        }

        $('#close-modal-btn').on('click', () => $('#bill-preview-modal').addClass('hidden'));

        // Final Confirmation and Save (AJAX POST to Flask)
        $('#confirm-save-btn').on('click', function() {
            const btn = $(this);
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i> Saving...');

            const totalBillData = {
                customer_name: customerNameInput.val(),
                phone: phoneInput.val(),
                customer_type: customerTypeHidden.val(),
                payment_method: selectedPaymentMethod,

                // Summary totals (sent for Flask calculation/verification)
                subtotal: parseFloat(summarySubtotalEl.text().replace('₹', '')),
                tax: parseFloat(summaryTaxEl.text().replace('₹', '')),
                total: parseFloat(summaryOrderTotalEl.text().replace('₹', '')),

                // Core item data for backend transaction
                products: productsInBill.map(p => ({
                    name: p.name,
                    quantity: p.quantity,
                    price: p.price
                }))
            };

            $.ajax({
                url: '/api/bill/save',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(totalBillData),
                success: function(response) {
                    showToast(response.message, false);
                    $('#modal-bill-id').text(response.bill_id);
                    // Open print dialog after successful save
                    window.print();
                    $('#bill-preview-modal').addClass('hidden');
                    resetForm();
                },
                error: (jqXHR, s, e) => {
                    handleAjaxError(jqXHR, s, e, "save the bill");
                    $('#modal-bill-id').text('FAILED');
                },
                complete: function() {
                    btn.prop('disabled', false).html('<i class="fas fa-save mr-2"></i>Confirm & Save Bill');
                }
            });
        });


        // --- Initial Setup ---
        calculateTotals();
        setCurrentDate();
        // Initialize payment button state
        $('#payment-methods').find('.payment-method-btn[data-method="UPI"]').trigger('click');
    });
</script>

</body>
</html>
